AWSTemplateFormatVersion: '2010-09-09'
Transform: AWS::Serverless-2016-10-31

Parameters:
  S3BucketName:
    Type: String
    Description: Name of the S3 bucket to store updates
  AirtableWebhookUrl:
    Type: String
    Description: Airtable webhook URL for notifications
    NoEcho: true

Resources:
  DrawCheckerFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: src/functions/draw-checker/
      Handler: lambda_function.lambda_handler
      Runtime: python3.12
      Timeout: 30
      MemorySize: 128
      Environment:
        Variables:
          WEBHOOK_URL: !Ref AirtableWebhookUrl
          S3_BUCKET: !Ref S3BucketName
      Policies:
        - S3CrudPolicy:
            BucketName: !Ref S3BucketName
      Events:
        DrawCheckerSchedule:
          Type: Schedule
          Properties:
            Schedule: rate(15 minutes)
            Enabled: true

  ImmiwatchBucket:
    Type: AWS::S3::Bucket
    Properties:
      BucketName: !Ref S3BucketName
      VersioningConfiguration:
        Status: Enabled
      LifecycleConfiguration:
        Rules:
          - Id: DeleteOldFiles
            Status: Enabled
            ExpirationInDays: 90

Outputs:
  DrawCheckerFunction:
    Description: "Draw Checker Lambda Function ARN"
    Value: !GetAtt DrawCheckerFunction.Arn
  DrawCheckerFunctionRole:
    Description: "Implicit IAM Role created for the draw checker function"
    Value: !GetAtt DrawCheckerFunctionRole.Arn
