name: ğŸ“° News Automation

on:
  repository_dispatch:
    types: [news_article]

jobs:
  process-news:
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
        
      - name: ğŸ Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
          
      - name: ğŸ“¦ Install dependencies
        run: |
          pip install requests
          
      - name: ğŸ” Determine Article Type
        id: article_type
        run: |
          # Read the event data to determine category
          if [ -f "$GITHUB_EVENT_PATH" ]; then
            CATEGORY=$(jq -r '.client_payload.category // .client_payload.draw_type // "general"' "$GITHUB_EVENT_PATH")
            echo "category=$CATEGORY" >> $GITHUB_OUTPUT
            
            # Check if this is a draw article
            if [[ "$CATEGORY" == "draw" || "$CATEGORY" == "draws" || "$CATEGORY" == "CEC" || "$CATEGORY" == "Health" || "$CATEGORY" == "PNP" || "$CATEGORY" == "General" || "$CATEGORY" == "FSTP" || "$CATEGORY" == "FSWP" ]]; then
              echo "is_draw=true" >> $GITHUB_OUTPUT
              echo "automation_script=draw_automation.py" >> $GITHUB_OUTPUT
            else
              echo "is_draw=false" >> $GITHUB_OUTPUT
              echo "automation_script=news_automation.py" >> $GITHUB_OUTPUT
            fi
          else
            echo "category=general" >> $GITHUB_OUTPUT
            echo "is_draw=false" >> $GITHUB_OUTPUT
            echo "automation_script=news_automation.py" >> $GITHUB_OUTPUT
          fi
          
      - name: ğŸ¯ Process Draw Article
        if: steps.article_type.outputs.is_draw == 'true'
        id: draw_automation
        run: |
          python scripts/draw_automation.py > draw_output.txt 2>&1
          if [ $? -eq 0 ]; then
            echo "success=true" >> $GITHUB_OUTPUT
            if grep -q "article_url=" draw_output.txt; then
              ARTICLE_URL=$(grep "article_url=" draw_output.txt | cut -d'=' -f2)
              echo "article_url=$ARTICLE_URL" >> $GITHUB_OUTPUT
            fi
            if grep -q "title=" draw_output.txt; then
              TITLE=$(grep "title=" draw_output.txt | cut -d'=' -f2)
              echo "title=$TITLE" >> $GITHUB_OUTPUT
            fi
          else
            echo "success=false" >> $GITHUB_OUTPUT
            if grep -q "error=" draw_output.txt; then
              ERROR=$(grep "error=" draw_output.txt | cut -d'=' -f2)
              echo "error=$ERROR" >> $GITHUB_OUTPUT
            fi
          fi
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
          
      - name: ğŸ“° Process General News Article
        if: steps.article_type.outputs.is_draw == 'false'
        id: news_automation
        run: |
          python scripts/news_automation.py > news_output.txt 2>&1
          if [ $? -eq 0 ]; then
            echo "success=true" >> $GITHUB_OUTPUT
            if grep -q "article_url=" news_output.txt; then
              ARTICLE_URL=$(grep "article_url=" news_output.txt | cut -d'=' -f2)
              echo "article_url=$ARTICLE_URL" >> $GITHUB_OUTPUT
            fi
            if grep -q "title=" news_output.txt; then
              TITLE=$(grep "title=" news_output.txt | cut -d'=' -f2)
              echo "title=$TITLE" >> $GITHUB_OUTPUT
            fi
          else
            echo "success=false" >> $GITHUB_OUTPUT
            if grep -q "error=" news_output.txt; then
              ERROR=$(grep "error=" news_output.txt | cut -d'=' -f2)
              echo "error=$ERROR" >> $GITHUB_OUTPUT
            fi
          fi
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL || '' }}
          
      - name: ğŸ“ Commit and Push Changes
        if: steps.draw_automation.outputs.success == 'true' || steps.news_automation.outputs.success == 'true'
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add .
          
          # Determine commit message based on article type
          if [ "${{ steps.article_type.outputs.is_draw }}" == "true" ]; then
            git commit -m "ğŸ¯ AUTO: New Draw Article - ${{ steps.draw_automation.outputs.title }}"
          else
            git commit -m "ğŸ“° AUTO: New News Article - ${{ steps.news_automation.outputs.title }}"
          fi
          
          git push origin main
          
      - name: ğŸ‰ Success Notification
        if: steps.draw_automation.outputs.success == 'true' || steps.news_automation.outputs.success == 'true'
        run: |
          if [ "${{ steps.article_type.outputs.is_draw }}" == "true" ]; then
            echo "âœ… Draw article created successfully!"
            echo "ğŸ“„ Article URL: ${{ steps.draw_automation.outputs.article_url }}"
            echo "ğŸ“ Title: ${{ steps.draw_automation.outputs.title }}"
          else
            echo "âœ… News article created successfully!"
            echo "ğŸ“„ Article URL: ${{ steps.news_automation.outputs.article_url }}"
            echo "ğŸ“ Title: ${{ steps.news_automation.outputs.title }}"
          fi
          
      - name: âŒ Error Notification
        if: steps.draw_automation.outputs.success == 'false' || steps.news_automation.outputs.success == 'false'
        run: |
          if [ "${{ steps.article_type.outputs.is_draw }}" == "true" ]; then
            echo "âŒ Draw article creation failed!"
            echo "ğŸš¨ Error: ${{ steps.draw_automation.outputs.error }}"
          else
            echo "âŒ News article creation failed!"
            echo "ğŸš¨ Error: ${{ steps.news_automation.outputs.error }}"
          fi 