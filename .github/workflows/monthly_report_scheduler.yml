name: Monthly Report Scheduler

on:
  schedule:
    # Run daily at 2 AM UTC to check for month transitions
    - cron: '0 2 * * *'
  workflow_dispatch: # Allow manual triggering

jobs:
  check-month-transition:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        
    - name: Check month transition
      id: transition
      run: |
        python3 scripts/current_monthly_report_manager.py --check-transition
        
    - name: Notify Slack - New Month Created
      if: steps.transition.outputs.status == 'month_transition'
      run: |
        curl -X POST -H 'Content-type: application/json' \
        --data '{
          "text": "ğŸ“… *New Monthly Report Created!*\n\nğŸ¯ **New Month:** ${{ steps.transition.outputs.new_month }}\nğŸ“ **Report File:** ${{ steps.transition.outputs.report_file }}\nğŸ”— **View Report:** https://immiwatch.ca/reports/express-entry/${{ steps.transition.outputs.new_month_directory }}/\n\nâœ… **Status:** New month report created and designated as current\n\nğŸ“Š **Ready for:** Express Entry draws for ${{ steps.transition.outputs.new_month }}"
        }' \
        https://hooks.slack.com/services/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
        
    - name: Notify Slack - No Transition
      if: steps.transition.outputs.status == 'no_transition_needed'
      run: |
        curl -X POST -H 'Content-type: application/json' \
        --data '{
          "text": "âœ… *Monthly Report Check Complete*\n\nğŸ“… **Current Month:** ${{ steps.transition.outputs.current_month }}\nğŸ“Š **Status:** No month transition needed\n\nğŸ”„ **Next Check:** Tomorrow at 2 AM UTC"
        }' \
        https://hooks.slack.com/services/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
        
    - name: Notify Slack - Error
      if: steps.transition.outputs.status == 'error'
      run: |
        curl -X POST -H 'Content-type: application/json' \
        --data '{
          "text": "âŒ *Monthly Report Check Failed!*\n\nğŸš¨ **Error:** ${{ steps.transition.outputs.error }}\n\nâš ï¸ **Action Required:** Manual intervention needed to check monthly report system"
        }' \
        https://hooks.slack.com/services/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 