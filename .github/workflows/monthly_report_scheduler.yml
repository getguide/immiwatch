name: Monthly Report Scheduler

on:
  schedule:
    # Run daily at 2 AM UTC to check for month transitions
    - cron: '0 2 * * *'
  workflow_dispatch: # Allow manual triggering

jobs:
  check_monthly_transition:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        
    - name: Check monthly transition
      id: transition
      run: |
        python3 scripts/current_monthly_report_manager.py --check-transition
        
    - name: Notify Slack - New Month Created
      if: steps.transition.outputs.status == 'month_transition'
      run: |
        curl -X POST -H 'Content-type: application/json' \
        --data '{
          "text": "ğŸ“… *New Monthly Report Created!*\n\nğŸ¯ **New Month:** ${{ steps.transition.outputs.new_month }}\nğŸ“ **Report File:** ${{ steps.transition.outputs.report_file }}\nğŸ”— **View Report:** https://immiwatch.ca/reports/express-entry/${{ steps.transition.outputs.new_month_directory }}/\n\nâœ… **Status:** New month report created and designated as current\n\nğŸ“Š **Ready for:** Express Entry draws for ${{ steps.transition.outputs.new_month }}\n\nğŸ“‹ **Summary:** Created fresh monthly report template for ${{ steps.transition.outputs.new_month }} with 0 ITAs baseline"
        }' \
        ${{ secrets.SLACK_WEBHOOK_URL }}
    
    - name: Notify Slack - No Transition
      if: steps.transition.outputs.status == 'no_transition_needed'
      run: |
        curl -X POST -H 'Content-type: application/json' \
        --data '{
          "text": "âœ… *Monthly Report Check Complete*\n\nğŸ“… **Current Month:** ${{ steps.transition.outputs.current_month }}\nğŸ“Š **Status:** No month transition needed\n\nğŸ”„ **Next Check:** Tomorrow at 2 AM UTC\n\nğŸ“‹ **Summary:** Daily check completed - current month report is active and ready for draws"
        }' \
        ${{ secrets.SLACK_WEBHOOK_URL }}
    
    - name: Notify Slack - Error
      if: steps.transition.outputs.status == 'error'
      run: |
        curl -X POST -H 'Content-type: application/json' \
        --data '{
          "text": "âŒ *Monthly Report Check Failed!*\n\nğŸš¨ **Error Details:**\n${{ steps.transition.outputs.error }}\n\nğŸ” **Debug Info:**\nâ€¢ **GitHub Run:** ${{ github.run_id }}\nâ€¢ **Workflow:** ${{ github.workflow }}\nâ€¢ **Repository:** ${{ github.repository }}\nâ€¢ **Branch:** ${{ github.ref }}\n\nâš ï¸ **Action Required:** Manual intervention needed to check monthly report system\n\nğŸ”— **View Logs:** https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"
        }' \
        ${{ secrets.SLACK_WEBHOOK_URL }} 